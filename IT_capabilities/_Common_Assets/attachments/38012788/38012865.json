{
    "openapi": "3.0.3",
    "info": {
        "title": "PTSRESTDDM",
        "version": "1.0",
        "description": "API pro validaci, vytvoření, smazaní a zjištění stavu DDM v PTS"
    },
    "servers": [
        {
            "url": "{protocol}://{serverName}:{port}/{basePath}",
            "description": "Testovací API server",
            "variables": {
                "protocol": {
                    "enum": [
                        "http",
                        "https"
                    ],
                    "default": "DOPLNI_BANKA",
                    "description": "internetový protokol aplikační vrstvy"
                },
                "serverName": {
                    "default": "DOPLNI_BANKA",
                    "description": "název hostitele"
                },
                "port": {
                    "default": "DOPLNI_BANKA",
                    "description": "port"
                },
                "basePath": {
                    "default": "PTSRESTDDM"
                }
            }
        },
        {
            "url": "{protocol}://{serverName}:{port}/{basePath}",
            "description": "Produkční API server",
            "variables": {
                "protocol": {
                    "enum": [
                        "http",
                        "https"
                    ],  
                    "default": "DOPLNI_BANKA",
                    "description": "Internetový protokol aplikační vrstvy"
                },
                "serverName": {
                    "default": "DOPLNI_BANKA",
                    "description": "název hostitele"
                },
                "port": {
                    "default": "DOPLNI_BANKA",
                    "description": "port"
                },
                "basePath": {
                    "default": "PTSRESTDDM"
                }
            }
        }
    ],
    "paths": {
        "/validate": {
            "post": {
                "summary": "Validace DDM",
                "description": "Vrací výsledek validace DDM",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/DDMRequest"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ValidateResponse"
                                }
                            }
                        }
                    },
                    "500": {
                        "$ref": "#/components/responses/InternalServerError"  
                    }        
                }
            }
        },
        "/ddm": {
            "post": {
                "summary": "Založení DDM",
                "description": "Vrací výsledek založení DDM",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/DDMRequest"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/CreateResponse"
                                }
                            }
                        }
                    },
                    "500": {
                        "$ref": "#/components/responses/InternalServerError"
                    }        
                }
            }      
        },
        "/ddm/{ptsId}": {
            "parameters": [
                {
                    "name": "ptsId",
                    "in": "path",
                    "description": "id DDM",
                    "required": true,
                    "schema": {   
                        "$ref": "#/components/schemas/PTSId"
                    }
                }
            ],
            "get": {
                "summary": "Stav DDM",
                "description": "Vrací stav DDM",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "object",
                                    "properties": {
                                        "PTSDdmId": {
                                            "$ref": "#/components/schemas/PTSId"
                                        },
                                        "directDebitMandateStatus": {
                                            "type": "string",
                                            "description": "Status DDM",
                                            "enum": [ "WAITING_ACTIVATION" , "ACTIVE", "CANCELLED" ]
                                        } 
                                    },
                                    "required": [
                                        "PTSDdmId",
                                        "directDebitMandateStatus"
                                    ]
                                }
                            }
                        }
                    },
                    "400": {
                        "$ref": "#/components/responses/BadRequest"  
                    },
                    "404": {
                        "$ref": "#/components/responses/NotFound"
                    },
                    "500": {
                        "$ref": "#/components/responses/InternalServerError"
                    }         
                }
            },
            "put": {
                "summary": "Editace DDM",
                "description": "Vrací výsledek editace DDM",
                "requestBody": {
                    "content": {
                        "application/json": {
                            "schema": {
                                "$ref": "#/components/schemas/DDMPutRequest"
                            }
                        }
                    }
                },
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/CreateResponse"
                                }
                            }
                        }
                    },
                    "400": {
                        "$ref": "#/components/responses/BadRequest"  
                    },
                    "403": {
                        "description": "DDM nelze upravit",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorModel"
                                }
                            }
                        }
                    },
                    "404": {
                        "$ref": "#/components/responses/NotFound"
                    },
                    "500": {
                        "$ref": "#/components/responses/InternalServerError"
                    }         
                }
            },
            "delete": {
                "summary": "Zrušení DDM",
                "description": "Zruší DDM v PTS",
                "responses": {
                    "204": {
                        "description": "OK"
                    },
                    "400": {
                        "$ref": "#/components/responses/BadRequest"
                    },
                    "403": {
                        "description": "DDM nelze zrušit",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "$ref": "#/components/schemas/ErrorModel"
                                }
                            }
                        }
                    },
                    "404": {
                        "$ref": "#/components/responses/NotFound"
                    },
                    "500": {
                        "$ref": "#/components/responses/InternalServerError"
                    }        
                }
            }
        },
        "/cid": {
            "parameters": [
                {
                    "name": "cidLike",
                    "in": "query",
                    "description": "Hledaná část CIDu inkasanta",
                    "required": false,
                    "schema": {   
                        "type": "string"
                    }
                },
                {
                    "name": "creditorNameLike",
                    "in": "query",
                    "description": "Hledaná část názvu inkasanta",
                    "required": false,
                    "schema": {   
                        "type": "string"
                    }
                }
            ],
            "get": {
                "summary": "Hledání CIDu",
                "description": "Vrací informace o 0..* CIDech pro zadané parametry, bez parametrů vrátí všechny CIDy",
                "responses": {
                    "200": {
                        "description": "OK",
                        "content": {
                            "application/json": {
                                "schema": {
                                    "type": "array",
                                    "items": {
                                        "type": "object",
                                        "description": "kód a hodnota poplatku",
                                        "properties": {
                                            "cid": {
                                                "$ref": "#/components/schemas/CID"
                                            },
                                            "creditorName": {
                                                "$ref": "#/components/schemas/Max70Text"   
                                            }
                                        },
                                        "required": [ "cid", "creditorName" ]
                                    }  
                                }
                            }
                        }
                    },
                    "500": {
                        "$ref": "#/components/responses/InternalServerError"
                    }         
                }
            }
        }
    },
    "components": {
        "schemas": {
            "ErrorModel": {
                "type": "object",
                "properties": {
                    "message": {
                        "type": "string",
                        "description": "Popis chyby",
                        "minLength": 1
                    }
                },
                "required": [
                    "message"
                ] 
            },
            "AmtValue": {
                "type": "number",
                "description": "Hodnota částky",
                "minimum": 0.01,
                "exclusiveMinimum": false
            },
            "Currency": {
                "type": "string",
                "description": "Kod meny podle ISO 4217 = 3 velka pismena",
                "pattern": "[A-Z]{3,3}"
            },
            "DDMRequest": {
                "type": "object",
                "properties": {
                    "operationId": {
                        "$ref": "#/components/schemas/OperationId"
                    },
                    "sourceChannel": {
                        "$ref": "#/components/schemas/SourceChannel"
                    },
                    "directDebitMandateIdentification": {
                        "$ref": "#/components/schemas/DirectDebitMandateIdentification"
                    },
                    "directDebitMandate": {
                        "allOf": [
                            {   
                                "type": "object",
                                "properties": {
                                    "mandateId": {
                                        "type": "string",
                                        "minLength": 1,
                                        "maxLength": 50,
                                        "pattern": "\\S+.*"    
                                    },
                                    "cid": {
                                        "$ref": "#/components/schemas/CID"
                                    }
                                 },
                                 "required": [ "cid", "mandateId"]                               
                            },
                            {
                                "$ref": "#/components/schemas/DirectDebitMandate"    
                            }
                        ]                      
                    },
                    "requestedExecutionDate": {
                        "$ref": "#/components/schemas/RequestedExecutionDate"
                    },
                    "debtorAccount": {
                        "$ref": "#/components/schemas/AccountElement"    
                    },
                    "note": {
                        "$ref": "#/components/schemas/Max70Text"
                    }
                },
                "required": [
                    "operationId",
                    "sourceChannel",
                    "directDebitMandateIdentification",
                    "directDebitMandate",
                    "debtorAccount"
                ]      
            },
            "DDMPutRequest": {
                "type": "object",
                "properties": {
                    "operationId": {
                        "$ref": "#/components/schemas/OperationId"
                    },
                    "sourceChannel": {
                        "$ref": "#/components/schemas/SourceChannel"
                    },
                    "directDebitMandateIdentification": {
                        "$ref": "#/components/schemas/DirectDebitMandateIdentification"
                    },
                    "directDebitMandate": {
                        "$ref": "#/components/schemas/DirectDebitMandate"
                    },
                    "requestedExecutionDate": {
                        "$ref": "#/components/schemas/RequestedExecutionDate"
                    },
                    "note": {
                        "$ref": "#/components/schemas/Max70Text"
                    }
                },
                "required": [
                    "operationId",
                    "sourceChannel",
                    "directDebitMandateIdentification",
                    "directDebitMandate"
                ]      
            },
            "ValidateResponse": {
                "type": "object",
                "properties": {
                    "validationStatus": {
                        "type": "boolean",
                        "description": "Vysledek validace"
                    },
                    "validationError": {
                        "$ref": "#/components/schemas/ValidationError"
                    }                    
                },
                "required": [
                    "validationStatus"
                ] 
            },
            "CreateResponse": {
                "type": "object",
                "properties": {     
                    "instructionResult": {
                        "type": "string",
                        "description": "Vysledek zalozeni DDM",
                        "enum": [ "OK", "Error" ]
                    },          
                    "validationError": {
                        "$ref": "#/components/schemas/ValidationError"
                    },
                    "directDebitMandateIdentification": {
                        "allOf": [
                            {
                                "$ref": "#/components/schemas/DirectDebitMandateIdentification"    
                            },
                            {
                                "type": "object",
                                "properties": {
                                    "operationId": {
                                        "$ref": "#/components/schemas/OperationId"    
                                    },
                                    "PTSDdmId": {
                                        "$ref": "#/components/schemas/PTSId"    
                                    }
                                },
                                "required": [ "operationId", "PTSDdmId" ]     
                            }
                        ]
                    } 
                },
                "required": [
                    "instructionResult"
                ] 
            },
            "OperationId": {
                "type": "string",
                "description": "Systémové ID DDM",
                "minLength": 1,
                "maxLength": 20,
                "pattern": "\\S+.+"    
            },
            "SourceChannel": {
                "type": "string",
                "description": "Zdroj DDM- kod aplikace/rozhraní, která/é zakládá DDM",
                "pattern": "[A-Z0-9]{2,3}"
            },
            "PTSId": {
                "type": "integer",
                "format": "int64",
                "description": "Unikatni PTS ID"
            },
            "ValidationError": {
                "type": "object",
                "properties": {
                    "errorCode": {
                        "type": "string",
                        "description": "Textový kód chyby",
                        "enum": ["NARATIVE", "FIELD_MISSING", "FIELD_INVALID"]
                    },
                    "errorScope": {
                        "type": "string",
                        "description": "Puvodce chyby",
                        
                    },
                    "errorMsg": {
                        "type": "string",
                        "description": "Popis chyby"
                    }
                },
                "required": [
                    "errorCode",
                    "errorScope",
                    "errorMsg"                   
                ]    
            },
            "CID": {
                "type": "string",
                "minLength": 9,
                "maxLength": 35,
                "pattern": "[A-Z0-9]"
            },
            "DirectDebitMandate": {
                "type": "object",
                "description": "",
                "properties": {
                    "alias": {
                        "type": "string"
                    },
                    "scheme": {
                        "type": "string",
                        "enum": [ "CORE", "B2B" ],
                        "default": "CORE"
                    },
                    "limit": {
                        "type": "object",
                        "description": "",
                        "properties": {
                            "amountSingleLimit": {
                                "$ref": "#/components/schemas/AmtValue"
                            },
                            "amountSumLimit": {
                                "$ref": "#/components/schemas/AmtValue"
                            },
                            "maxIterations": {
                                "type": "integer",
                                "description": "maximální počet opakování inkasa",
                                "minimum": 1                                        
                            }
                        }
                    },
                    "validity": {
                        "type": "object",
                        "properties": {
                            "lastExecutionDate": {
                                "type": "string",
                                "format": "date",
                                "description": "platné do"
                            }
                        }
                    },
                    "isRepeat": {
                        "type": "boolean",
                        "description": "opakované inkaso"
                    },
                    "referredDocumentInformation": {
                        "type": "object",
                        "properties": {
                            "referredDocument": {
                                "$ref": "#/components/schemas/Max35Text"
                            },
                            "dateOfSignature": {
                                "type": "string",
                                "description": "Datum podpisu",
                                "format": "date"
                            }
                        }
                    }
                },
                "required": [
                    "scheme"
                ]
            },
            "RequestedExecutionDate": {
                "type": "string",
                "description": "Datum splatnosti",
                "format": "date"
            },
            "DirectDebitMandateIdentification": {
                "type": "object",
                "properties": {
                    "instructionIdentification": {
                        "type": "string",
                        "description": "Unikátní ID DDM",
                        "minLength": 1,
                        "maxLength": 35
                    }
                },
                "required": [ "instructionIdentification" ]
            },
            "AccountElement": {
                "type": "object",
                "description": "",
                "properties": {
                    "identification": {
                        "$ref": "#/components/schemas/AccountIdentification"
                    },
                    "currency": {
                        "$ref": "#/components/schemas/Currency"    
                    }
                }
            },
            "AccountIdentification": {
                "allOf": [
                    {
                        "anyOf": [
                            {
                                "type": "object",                                
                                "properties": {
                                    "iban": {
                                        "type": "string",
                                        "description": "IBAN",
                                        "pattern": "[A-Z]{2,2}[0-9]{2,2}[a-zA-Z0-9]{1,30}"
                                    }
                                },
                                "required": [ "iban" ]   
                            },
                            {
                                "type": "object",
                                "description": "Jina identifikace uctu",
                                "properties": {
                                    "other": {
                                        "type": "object",
                                        "properties": {
                                            "identification": {
                                                "type": "string",
                                                "description": "Quaestor ID nebo cislo uctu",
                                                "minLength": 1,
                                                "maxLength": 34
                                            }
                                        },
                                        "required": [ "identification" ]
                                    }
                                },
                                "required": [ "other" ]   
                            },
                            {
                                "type": "object",                               
                                "properties": {
                                    "bban": {
                                        "type": "string",
                                        "description": "Cislo uctu v tuzemskem tvaru",
                                        "pattern": "[0-9]{1,16}"
                                    }
                                },
                                "required": [ "bban" ]   
                            }                    
                        ]
                    },
                    {
                        "type": "object",
                        "description": "",
                        "properties": {
                            "bankcode": {
                                "type": "string",
                                "description": "CNB kod banky",
                                "pattern": "[0-9]{4,4}"
                            }
                        }
                    }
                ]
            },
            "Max35Text": {
                "type": "string",
                "minLength": 1,
                "maxLength": 35,
                "pattern": "\\S+.*"
            },
            "Max70Text": {
                "type": "string",
                "minLength": 1,
                "maxLength": 70,
                "pattern": "\\S+.*"
            }
        },
        "responses": {
            "BadRequest": {
                "description": "Nevalidní ID",
                "content": {
                    "application/json": {
                        "schema": {
                            "$ref": "#/components/schemas/ErrorModel"
                        }
                    }
                }
            },
            "NotFound": {
                "description": "DDM nenalezeno",
                "content": {
                    "application/json": {
                        "schema": {
                            "$ref": "#/components/schemas/ErrorModel"
                        }
                    }
                }
            },
            "InternalServerError": {
                "description": "Internal Server Error",
                "content": {
                    "application/json": {
                        "schema": {
                            "$ref": "#/components/schemas/ErrorModel"
                        }
                    }
                }
            }
        }          
    }       
}
